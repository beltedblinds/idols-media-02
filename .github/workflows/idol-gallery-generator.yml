name: Idol Gallery Generator

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository (latest commit only)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1
          persist-credentials: true

      # 2Ô∏è‚É£ Restore cached thumbnails
      - name: Restore cached thumbnails
        uses: actions/cache@v4
        with:
          path: thumbnails
          key: thumbnails-${{ hashFiles('**/*.jpg','**/*.jpeg','**/*.png','**/*.webp','**/*.gif','**/*.mp4','**/*.avi','**/*.mov','**/*.mkv') }}
          restore-keys: |
            thumbnails-

      # 3Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow opencv-python-headless

      # 5Ô∏è‚É£ Generate thumbnails and gallery links
      - name: Generate idol_gallery_links_02.txt
        run: |
          python <<'PYCODE'
          import os
          from PIL import Image
          import cv2

          repo = os.environ["GITHUB_REPOSITORY"]
          branch = "main"
          base_raw = f"https://raw.githubusercontent.com/{repo}/{branch}/"

          output_lines = []
          total, skipped, updated = 0, 0, 0

          os.makedirs("thumbnails", exist_ok=True)

          # Function to make image thumbnail
          def make_image_thumbnail(input_path, thumb_path, size=(300,300)):
              try:
                  os.makedirs(os.path.dirname(thumb_path), exist_ok=True)
                  with Image.open(input_path) as im:
                      im.thumbnail(size)
                      im.save(thumb_path, "WEBP")
                      return thumb_path
              except Exception as e:
                  print(f"‚ö†Ô∏è Failed to create thumbnail for {input_path}: {e}")
                  return None

          # Function to make video thumbnail (first frame)
          def make_video_thumbnail(video_path, thumb_path, size=(300,300)):
              try:
                  os.makedirs(os.path.dirname(thumb_path), exist_ok=True)
                  vidcap = cv2.VideoCapture(video_path)
                  success, frame = vidcap.read()
                  vidcap.release()
                  if success:
                      frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                      im = Image.fromarray(frame)
                      im.thumbnail(size)
                      # Always save as .webp
                      if not thumb_path.lower().endswith(".webp"):
                          thumb_path = os.path.splitext(thumb_path)[0] + ".webp"
                      im.save(thumb_path, "WEBP")
                      return thumb_path
                  else:
                      print(f"‚ö†Ô∏è Could not read first frame of {video_path}")
                      return None
              except Exception as e:
                  print(f"‚ö†Ô∏è Failed to create thumbnail for {video_path}: {e}")
                  return None

          # Collect all media files
          media_files = []
          for root, dirs, files in os.walk("."):
              if any(skip in root for skip in [".github", ".git", "thumbnails"]):
                  continue
              for file in files:
                  if file.lower().endswith((".jpg",".jpeg",".png",".webp",".gif",".mp4",".avi",".mov",".mkv")):
                      media_files.append(os.path.relpath(os.path.join(root, file), "."))

          # Remove old thumbnails not in current media, but protect _manual files
          if os.path.exists("thumbnails"):
              for idol_folder in os.listdir("thumbnails"):
                  idol_path = os.path.join("thumbnails", idol_folder)
                  if not os.path.isdir(idol_path):
                      continue
                  for thumb_file in os.listdir(idol_path):
                      thumb_path = os.path.join(idol_path, thumb_file)
                      
                      # Check if this is a manual thumbnail
                      is_manual = "_manual" in thumb_file
                      
                      # Determine corresponding original media path(s)
                      base_name = os.path.splitext(thumb_file)[0]
                      possible_media_exts = [".jpg", ".jpeg", ".png", ".gif", ".mp4", ".avi", ".mov", ".mkv"]
                      
                      media_exists = any(
                          os.path.exists(os.path.join(idol_folder.replace(" ", "/"), base_name + ext))
                          for ext in possible_media_exts
                      )
                      
                      # Delete only if media does not exist
                      if not media_exists:
                          try:
                              os.remove(thumb_path)
                              print(f"üóë Deleted orphan thumbnail: {thumb_path}")
                          except Exception as e:
                              print(f"‚ö†Ô∏è Failed to delete {thumb_path}: {e}")


          # Process each media file
          for relative_path in media_files:
              total += 1
              folder = os.path.dirname(relative_path)
              idol_name = folder.replace("/", " ") if folder else os.path.splitext(relative_path)[0]
              file_name = os.path.basename(relative_path)
              ext = os.path.splitext(relative_path)[1].lower()
              thumb_path = os.path.join("thumbnails", idol_name, file_name)

              # Decide thumbnail generation method with _manual protection
              thumb_base = os.path.splitext(thumb_path)[0]
              manual_thumb_path = thumb_base + "_manual.webp"
              
              # If manual thumbnail exists, use it and skip generation
              if os.path.exists(manual_thumb_path):
                  thumb_path = manual_thumb_path  # Use manual for output
                  generate = False
                  skipped += 1
              else:
                  thumb_path = thumb_base + ".webp"
                  generate = True
              
              # Only generate if needed
              if generate:
                  if ext in (".mp4", ".avi", ".mov", ".mkv"):
                      if not os.path.exists(thumb_path):
                          result = make_video_thumbnail(relative_path, thumb_path)
                          if result:
                              updated += 1
                          else:
                              skipped += 1
                              continue
                      else:
                          skipped += 1
                  else:
                      if not os.path.exists(thumb_path):
                          result = make_image_thumbnail(relative_path, thumb_path)
                          if result:
                              updated += 1
                          else:
                              skipped += 1
                              continue
                      else:
                          skipped += 1



              raw_url = f"{base_raw}{relative_path}".replace(" ", "%20")
              thumb_url = f"{base_raw}{thumb_path.replace(os.sep,'/')}".replace(" ", "%20")

              output_lines.append(f"{idol_name}, {raw_url}, {thumb_url}, ")

          # Sort and write to single file
          output_lines.sort()
          with open("idol_gallery_links_02.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(output_lines))

          print(f"üìÑ Generated idol_gallery_links_02.txt with {total} items ‚Äî {updated} updated, {skipped} skipped")
          PYCODE

      # 6Ô∏è‚É£ Commit and push
      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add idol_gallery_links_02.txt thumbnails || true
          git commit -m "Auto-generate gallery + video thumbnails" || echo "No changes"
          git push

      # 7Ô∏è‚É£ Save thumbnails cache
      - name: Save thumbnails cache
        uses: actions/cache@v4
        with:
          path: thumbnails
          key: thumbnails-${{ hashFiles('**/*.jpg','**/*.jpeg','**/*.png','**/*.webp','**/*.gif','**/*.mp4','**/*.avi','**/*.mov','**/*.mkv') }}
          restore-keys: |
            thumbnails-
